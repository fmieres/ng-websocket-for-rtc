!function(){"use strict";angular.module("ng-websocket-for-rtc",["ngWebSocket"]),function(){function e(){function e(e){c=e}function t(){function e(e,r,o){r=r||{servers:{iceServers:c}},o=o||{},t.peer=new n(e,r,o)}var t={peer:void 0,initialize:e};return t}var r=this,c=[];r.setICEServers=e,r.$get=t}function n(e,n,t){function r(){e.serverSend({type:"queue_as_listener"})}function c(e,n){g.send(JSON.stringify({type:"chat",value:e,id:n}))}function o(e,n){navigator.mediaDevices.getUserMedia(n).then(function(n){e.srcObject=n,l.addStream(n),u()})}function i(e){var n=JSON.parse(e.data);if("chat"===n.type)t.onMessageReceived(n.value);else if("system"===n.type)switch(n.value){case"ack_message_received":t.onAckMessageReceived(n.id);break;default:console.log(n)}}function s(e){void 0!=e.ice?l.addIceCandidate(new RTCIceCandidate(e.ice)):e.sdp&&"offer"==e.sdp.type?l.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){return l.createAnswer()}).then(function(e){return l.setLocalDescription(e)}).then(function(){return v({sdp:l.localDescription})}):e.sdp&&"answer"==e.sdp.type?l.setRemoteDescription(new RTCSessionDescription(e.sdp)):console.log("wasnt expecting:",e)}function a(){console.log("log: ","accept"),e.serverSend({type:"accept_speaker"})}function u(){l.createOffer().then(function(e){l.setLocalDescription(e),v({sdp:l.localDescription})})}var d=this;d.sendVideo=o,d.sendMessage=c,d.queue=r;var f,l=new RTCPeerConnection(n.servers),g=l.createDataChannel("sendDataChannel",null);l.ondatachannel=function(e){f=e.channel,f.onmessage=i},l.onicecandidate=function(e){e.candidate&&v({ice:e.candidate})},l.onaddstream=function(e){t.onAddStream(e)},e.on_once("channel_webrtc",s),e.on_once("ack_message_received",function(){}),e.on_once("ask_take_call",a),e.on_once("assert_connected_with_pair",u);var v=e.send}angular.module("ng-websocket-for-rtc").provider("RtcPeerConnection",e)}(),function(){function e(){function e(e,r){function c(e){v.$server.send(JSON.stringify({data:e,type:"webrtc"}))}function o(e){v.$server.send(JSON.stringify({data:e,type:"server"}))}function i(){}function s(e,n){return v.$register.register(e,n)}function a(e,n){return v.$register_once.register(e,n)}function u(e){return v.$register.unregister(e)}function d(e){var n=JSON.parse(e.data);return n.keyword?v.$register.hasCallback(n.keyword)||v.$register_once.hasCallback(n.keyword)?f(n.keyword,[n.data,n.sender,e]):i(n,e):i(e)}function f(e,n){v.$register.callbacks(e).forEach(function(e){e.apply(void 0,n)}),v.$register_once.callbacks(e).forEach(function(e){e.apply(void 0,n)})}function l(e,n,t){return v.$register.hasCallback(e)||v.$register_once.hasCallback(e)?f(e,[n,t]):i(n,t)}function g(){return v.$server=e(r),v.$server.onMessage(d),v.$server.onOpen(function(){v.isReady=!0,l("system_on_open",event)}),v.$server.onClose(function(e){var n=v.isReady;v.isReady=!1,e.code==p&&setTimeout(function(){v.connect()},1e3),l("system_on_close",e,{lastReadyState:n})}),v.$server.onError(function(){v.isReady=!1}),v}var v=this,p=1006;v.isReady=!1,v.url=r,v.$register=new n,v.$register_once=new t,v.on=s,v.on_once=a,v.send=c,v.connect=g,v.unregister=u,v.serverSend=o}function n(){function e(e,n){var t=o(),r=s[e];if(r)r[t]=n;else{var c={};c[t]=n,s[e]=c}return i[t]=e,t}function n(e){return!!s[e]}function t(e){return Object.values(s[e]||{})}function r(e){var n=i[e];delete s[n][e]}var c=this,i={},s={};c.register=e,c.callbacks=t,c.unregister=r,c.hasCallback=n}function t(){function e(e,n){o[e]=n}function n(e){return c.hasCallback(e)?[o[e]]:[]}function t(e){delete o[e]}function r(e){return!!o[e]}var c=this,o={};c.register=e,c.callbacks=n,c.unregister=t,c.hasCallback=r}var r=this,c="",o=function(){return Math.random().toString()};r.webSocketUrl=function(e){c=e},r.generateIdStrategy=function(e){o=e},r.$get=["$websocket",function(n){var t=new e(n,c);return t.connect(),t}]}angular.module("ng-websocket-for-rtc").provider("WebSocket",e)}()}();