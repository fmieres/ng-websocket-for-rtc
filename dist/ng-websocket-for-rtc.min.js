!function(){"use strict";angular.module("ng-websocket-for-rtc",["ngWebSocket"]),function(){function e(){function e(e){a=e===r||e===t?e:r}function c(e){o=e}function i(){function e(e,r,c){r=r||{servers:{iceServers:o},socketType:a},c=c||{},t.peer=new n(e,r,c)}var t={peer:void 0,initialize:e};return t}var s=this,o=[],a=r;s.setICEServers=c,s.$get=i,s.setType=e,s.LISTENER=t,s.SPEAKER=r}function n(e,n,t){function c(){e.serverSend({type:"queue_as_listener"})}function i(){e.serverSend({type:"queue_as_speaker"})}function s(e,n){y.send(JSON.stringify({type:"chat",value:e,id:n}))}function o(e,n){navigator.mediaDevices.getUserMedia(n).then(function(n){e.srcObject=n,p.addStream(n),l()})}function a(){}function u(e){var n=JSON.parse(e.data);if("chat"===n.type)t.onMessageReceived(n.value),y.send(JSON.stringify({value:"ack_message_received",type:"system",id:n.id}));else if("system"===n.type)switch(n.value){case"ack_message_received":t.onAckMessageReceived(n.id);break;default:console.log(n)}}function d(e){void 0!=e.ice?p.addIceCandidate(new RTCIceCandidate(e.ice)):e.sdp&&"offer"==e.sdp.type?p.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){return p.createAnswer()}).then(function(e){return p.setLocalDescription(e)}).then(function(){return k({sdp:p.localDescription})}):e.sdp&&"answer"==e.sdp.type?p.setRemoteDescription(new RTCSessionDescription(e.sdp)):console.log("wasnt expecting:",e)}function f(){e.serverSend({type:"accept_speaker"})}function l(){p.createOffer().then(function(e){p.setLocalDescription(e),k({sdp:p.localDescription})})}var v=this;v.sendVideo=o,v.sendMessage=s,v.queue=n.socketType===r?i:c;var g,p=new RTCPeerConnection(n.servers),y=p.createDataChannel("sendDataChannel",null);p.ondatachannel=function(e){g=e.channel,g.onmessage=u},p.onicecandidate=function(e){e.candidate&&k({ice:e.candidate})},p.onaddstream=function(e){t.onAddStream(e)},e.on_once("channel_webrtc",d),e.on_once("ack_message_received",a),e.on_once("ask_take_call",f),e.on_once("assert_connected_with_pair",n.socketType===r?a:l);var k=e.send}angular.module("ng-websocket-for-rtc").provider("RTCPeerConnection",e);var t=0,r=1}(),function(){function e(){function e(e,r){function c(e){g.$server.send(JSON.stringify({data:e,type:"webrtc"}))}function i(e){g.$server.send(JSON.stringify({data:e,type:"server"}))}function s(){}function o(e,n){return g.$register.register(e,n)}function a(e,n){return g.$register_once.register(e,n)}function u(e){return g.$register.unregister(e)}function d(e){var n=JSON.parse(e.data);return n.keyword?g.$register.hasCallback(n.keyword)||g.$register_once.hasCallback(n.keyword)?f(n.keyword,[n.data,n.sender,e]):s(n,e):s(e)}function f(e,n){g.$register.callbacks(e).forEach(function(e){e.apply(void 0,n)}),g.$register_once.callbacks(e).forEach(function(e){e.apply(void 0,n)})}function l(e,n,t){return g.$register.hasCallback(e)||g.$register_once.hasCallback(e)?f(e,[n,t]):s(n,t)}function v(){return g.$server=e(r),g.$server.onMessage(d),g.$server.onOpen(function(){g.isReady=!0,l("system_on_open",event)}),g.$server.onClose(function(e){var n=g.isReady;g.isReady=!1,e.code==p&&setTimeout(function(){g.connect()},1e3),l("system_on_close",e,{lastReadyState:n})}),g.$server.onError(function(){g.isReady=!1}),g}var g=this,p=1006;g.isReady=!1,g.url=r,g.$register=new n,g.$register_once=new t,g.on=o,g.on_once=a,g.send=c,g.connect=v,g.unregister=u,g.serverSend=i}function n(){function e(e,n){var t=i(),r=o[e];if(r)r[t]=n;else{var c={};c[t]=n,o[e]=c}return s[t]=e,t}function n(e){return!!o[e]}function t(e){return Object.values(o[e]||{})}function r(e){var n=s[e];delete o[n][e]}var c=this,s={},o={};c.register=e,c.callbacks=t,c.unregister=r,c.hasCallback=n}function t(){function e(e,n){i[e]=n}function n(e){return c.hasCallback(e)?[i[e]]:[]}function t(e){delete i[e]}function r(e){return!!i[e]}var c=this,i={};c.register=e,c.callbacks=n,c.unregister=t,c.hasCallback=r}var r=this,c="",i=function(){return Math.random().toString()};r.webSocketUrl=function(e){c=e},r.generateIdStrategy=function(e){i=e},r.$get=["$websocket",function(n){var t=new e(n,c);return t.connect(),t}]}angular.module("ng-websocket-for-rtc").provider("WebSocket",e)}()}();