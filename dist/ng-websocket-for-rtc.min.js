!function(){"use strict";angular.module("ng-websocket-for-rtc",["ngWebSocket"]),function(){function e(){function e(e){a=e===r||e===t?e:r}function c(e){s=e}function i(){function e(e,r,c){r=r||{servers:{iceServers:s},socketType:a},c=c||{},t.peer=new n(e,r,c)}var t={peer:void 0,initialize:e};return t}var o=this,s=[],a=r;o.setICEServers=c,o.$get=i,o.setType=e,o.LISTENER=t,o.SPEAKER=r}function n(e,n,t){function c(){e.serverSend({type:"queue_as_listener"})}function i(){e.serverSend({type:"queue_as_speaker"})}function o(e,n){k.send(JSON.stringify({type:"chat",value:e,id:n}))}function s(e,n){navigator.mediaDevices.getUserMedia(n).then(function(n){e.srcObject=n,g.addStream(n),l()})}function a(){}function u(e){var n=JSON.parse(e.data);if("chat"===n.type)t.onMessageReceived(n.value);else if("system"===n.type)switch(n.value){case"ack_message_received":t.onAckMessageReceived(n.id);break;default:console.log(n)}}function d(e){void 0!=e.ice?g.addIceCandidate(new RTCIceCandidate(e.ice)):e.sdp&&"offer"==e.sdp.type?g.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){return g.createAnswer()}).then(function(e){return g.setLocalDescription(e)}).then(function(){return y({sdp:g.localDescription})}):e.sdp&&"answer"==e.sdp.type?g.setRemoteDescription(new RTCSessionDescription(e.sdp)):console.log("wasnt expecting:",e)}function f(){e.serverSend({type:"accept_speaker"})}function l(){g.createOffer().then(function(e){g.setLocalDescription(e),y({sdp:g.localDescription})})}var v=this;v.sendVideo=s,v.sendMessage=o,v.queue=n.socketType===r?i:c;var p,g=new RTCPeerConnection(n.servers),k=g.createDataChannel("sendDataChannel",null);g.ondatachannel=function(e){p=e.channel,p.onmessage=u},g.onicecandidate=function(e){e.candidate&&y({ice:e.candidate})},g.onaddstream=function(e){t.onAddStream(e)},e.on_once("channel_webrtc",d),e.on_once("ack_message_received",a),e.on_once("ask_take_call",f),e.on_once("assert_connected_with_pair",n.socketType===r?a:l);var y=e.send}angular.module("ng-websocket-for-rtc").provider("RTCPeerConnection",e);var t=0,r=1}(),function(){function e(){function e(e,r){function c(e){p.$server.send(JSON.stringify({data:e,type:"webrtc"}))}function i(e){p.$server.send(JSON.stringify({data:e,type:"server"}))}function o(){}function s(e,n){return p.$register.register(e,n)}function a(e,n){return p.$register_once.register(e,n)}function u(e){return p.$register.unregister(e)}function d(e){var n=JSON.parse(e.data);return n.keyword?p.$register.hasCallback(n.keyword)||p.$register_once.hasCallback(n.keyword)?f(n.keyword,[n.data,n.sender,e]):o(n,e):o(e)}function f(e,n){p.$register.callbacks(e).forEach(function(e){e.apply(void 0,n)}),p.$register_once.callbacks(e).forEach(function(e){e.apply(void 0,n)})}function l(e,n,t){return p.$register.hasCallback(e)||p.$register_once.hasCallback(e)?f(e,[n,t]):o(n,t)}function v(){return p.$server=e(r),p.$server.onMessage(d),p.$server.onOpen(function(){p.isReady=!0,l("system_on_open",event)}),p.$server.onClose(function(e){var n=p.isReady;p.isReady=!1,e.code==g&&setTimeout(function(){p.connect()},1e3),l("system_on_close",e,{lastReadyState:n})}),p.$server.onError(function(){p.isReady=!1}),p}var p=this,g=1006;p.isReady=!1,p.url=r,p.$register=new n,p.$register_once=new t,p.on=s,p.on_once=a,p.send=c,p.connect=v,p.unregister=u,p.serverSend=i}function n(){function e(e,n){var t=i(),r=s[e];if(r)r[t]=n;else{var c={};c[t]=n,s[e]=c}return o[t]=e,t}function n(e){return!!s[e]}function t(e){return Object.values(s[e]||{})}function r(e){var n=o[e];delete s[n][e]}var c=this,o={},s={};c.register=e,c.callbacks=t,c.unregister=r,c.hasCallback=n}function t(){function e(e,n){i[e]=n}function n(e){return c.hasCallback(e)?[i[e]]:[]}function t(e){delete i[e]}function r(e){return!!i[e]}var c=this,i={};c.register=e,c.callbacks=n,c.unregister=t,c.hasCallback=r}var r=this,c="",i=function(){return Math.random().toString()};r.webSocketUrl=function(e){c=e},r.generateIdStrategy=function(e){i=e},r.$get=["$websocket",function(n){var t=new e(n,c);return t.connect(),t}]}angular.module("ng-websocket-for-rtc").provider("WebSocket",e)}()}();