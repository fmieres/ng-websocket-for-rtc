!function(){"use strict";angular.module("ng-websocket-for-rtc",["ngWebSocket"]),function(){function e(){function e(e){o=e}function c(){function e(e,r,c){r=r||{servers:{iceServers:o},socketType:s},c=c||{},t.peer=new n(e,r,c)}var t={peer:void 0,initialize:e};return t}var i=this,o=[],s=r;i.setICEServers=e,i.$get=c,i.setType,i.LISTENER=t,i.SPEAKER=r}function n(e,n,t){function c(){e.serverSend({type:"queue_as_listener"})}function i(){e.serverSend({type:"queue_as_speaker"})}function o(e,n){p.send(JSON.stringify({type:"chat",value:e,id:n}))}function s(e,n){navigator.mediaDevices.getUserMedia(n).then(function(n){e.srcObject=n,g.addStream(n),f()})}function a(e){var n=JSON.parse(e.data);if("chat"===n.type)t.onMessageReceived(n.value);else if("system"===n.type)switch(n.value){case"ack_message_received":t.onAckMessageReceived(n.id);break;default:console.log(n)}}function u(e){void 0!=e.ice?g.addIceCandidate(new RTCIceCandidate(e.ice)):e.sdp&&"offer"==e.sdp.type?g.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(){return g.createAnswer()}).then(function(e){return g.setLocalDescription(e)}).then(function(){return k({sdp:g.localDescription})}):e.sdp&&"answer"==e.sdp.type?g.setRemoteDescription(new RTCSessionDescription(e.sdp)):console.log("wasnt expecting:",e)}function d(){e.serverSend({type:"accept_speaker"})}function f(){g.createOffer().then(function(e){g.setLocalDescription(e),k({sdp:g.localDescription})})}var l=this;l.sendVideo=s,l.sendMessage=o,l.queue=n.socketType===r?i:c;var v,g=new RTCPeerConnection(n.servers),p=g.createDataChannel("sendDataChannel",null);g.ondatachannel=function(e){v=e.channel,v.onmessage=a},g.onicecandidate=function(e){e.candidate&&k({ice:e.candidate})},g.onaddstream=function(e){t.onAddStream(e)},e.on_once("channel_webrtc",u),e.on_once("ack_message_received",function(){}),e.on_once("ask_take_call",d),e.on_once("assert_connected_with_pair",f);var k=e.send}angular.module("ng-websocket-for-rtc").provider("RTCPeerConnection",e);var t=0,r=1}(),function(){function e(){function e(e,r){function c(e){g.$server.send(JSON.stringify({data:e,type:"webrtc"}))}function i(e){g.$server.send(JSON.stringify({data:e,type:"server"}))}function o(){}function s(e,n){return g.$register.register(e,n)}function a(e,n){return g.$register_once.register(e,n)}function u(e){return g.$register.unregister(e)}function d(e){var n=JSON.parse(e.data);return n.keyword?g.$register.hasCallback(n.keyword)||g.$register_once.hasCallback(n.keyword)?f(n.keyword,[n.data,n.sender,e]):o(n,e):o(e)}function f(e,n){g.$register.callbacks(e).forEach(function(e){e.apply(void 0,n)}),g.$register_once.callbacks(e).forEach(function(e){e.apply(void 0,n)})}function l(e,n,t){return g.$register.hasCallback(e)||g.$register_once.hasCallback(e)?f(e,[n,t]):o(n,t)}function v(){return g.$server=e(r),g.$server.onMessage(d),g.$server.onOpen(function(){g.isReady=!0,l("system_on_open",event)}),g.$server.onClose(function(e){var n=g.isReady;g.isReady=!1,e.code==p&&setTimeout(function(){g.connect()},1e3),l("system_on_close",e,{lastReadyState:n})}),g.$server.onError(function(){g.isReady=!1}),g}var g=this,p=1006;g.isReady=!1,g.url=r,g.$register=new n,g.$register_once=new t,g.on=s,g.on_once=a,g.send=c,g.connect=v,g.unregister=u,g.serverSend=i}function n(){function e(e,n){var t=i(),r=s[e];if(r)r[t]=n;else{var c={};c[t]=n,s[e]=c}return o[t]=e,t}function n(e){return!!s[e]}function t(e){return Object.values(s[e]||{})}function r(e){var n=o[e];delete s[n][e]}var c=this,o={},s={};c.register=e,c.callbacks=t,c.unregister=r,c.hasCallback=n}function t(){function e(e,n){i[e]=n}function n(e){return c.hasCallback(e)?[i[e]]:[]}function t(e){delete i[e]}function r(e){return!!i[e]}var c=this,i={};c.register=e,c.callbacks=n,c.unregister=t,c.hasCallback=r}var r=this,c="",i=function(){return Math.random().toString()};r.webSocketUrl=function(e){c=e},r.generateIdStrategy=function(e){i=e},r.$get=["$websocket",function(n){var t=new e(n,c);return t.connect(),t}]}angular.module("ng-websocket-for-rtc").provider("WebSocket",e)}()}();